{% extends "accounts/layout.html" %}

{% block title %}{{ transaction.description or 'Transaction' }} - The Brilliant Emporium{% endblock %}

{% block main %}
<div class="container py-4">
    <!-- Back Navigation -->
    <div class="mb-4">
        <a href="{{ url_for('transactions.index') }}" class="btn btn-outline-accent btn-sm mb-3">
            <i class="bi bi-arrow-left me-1"></i> Back to Transactions
        </a>
    </div>
    
    <!-- Transaction Details -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Transaction Details</h5>
                    <div class="btn-group">
                        <a href="{{ url_for('transactions.edit', transaction_id=transaction.id) }}" class="btn btn-sm btn-outline-accent">
                            <i class="bi bi-pencil me-1"></i> Edit
                        </a>
                        <a href="{{ url_for('transactions.create') }}?duplicate={{ transaction.id }}" class="btn btn-sm btn-accent">
                            <i class="bi bi-copy me-1"></i> Duplicate
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- Transaction Header -->
                    <div class="d-flex justify-content-between align-items-start mb-4 pb-4 border-bottom border-secondary">
                        <div>
                            <h1 class="h2 fw-bold mb-2 {{ 'text-success' if transaction.type.value == 'income' else 'text-danger' }}">
                                {{ '$%.2f'|format(transaction.amount) }}
                            </h1>
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                <span class="badge {{ 'bg-success' if transaction.type.value == 'income' else 'bg-danger' }}">
                                    {{ transaction.type.value|title }}
                                </span>
                                <span class="text-gray">{{ transaction.date.strftime('%B %d, %Y') }}</span>
                                <span class="text-gray">â€¢</span>
                                <span class="text-gray">{{ transaction.created_at.strftime('%I:%M %p') }}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fs-4 fw-bold">{{ transaction.account.currency }}</div>
                            <div class="text-gray">Currency</div>
                        </div>
                    </div>
                    
                    <!-- Transaction Details Grid -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-gray mb-1">Description</label>
                                <div class="text-light fs-5">{{ transaction.description or 'No description provided' }}</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label text-gray mb-1">Account</label>
                                <div class="d-flex align-items-center">
                                    <div class="bg-dark-gray rounded p-2 me-3">
                                        <i class="bi bi-wallet2 text-accent"></i>
                                    </div>
                                    <div>
                                        <div class="text-light">{{ transaction.account.name }}</div>
                                        <small class="text-gray">Current Balance: {{ transaction.account.currency }} {{ "%.2f"|format(transaction.account.current_balance) }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-gray mb-1">Category</label>
                                <div class="d-flex align-items-center">
                                    {% if transaction.category %}
                                    <div class="bg-dark-gray rounded p-2 me-3" style="background-color: {{ transaction.category.color }}20 !important;">
                                        <span class="fs-5" style="color: {{ transaction.category.color }}">{{ transaction.category.icon }}</span>
                                    </div>
                                    <div>
                                        <div class="text-light">{{ transaction.category.name }}</div>
                                        <small class="text-gray" style="color: {{ transaction.category.color }}">{{ transaction.category.type.value|title }}</small>
                                    </div>
                                    {% else %}
                                    <div class="bg-dark-gray rounded p-2 me-3">
                                        <i class="bi bi-question-circle text-gray"></i>
                                    </div>
                                    <div>
                                        <div class="text-light">Uncategorized</div>
                                        <small class="text-gray">No category assigned</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label text-gray mb-1">Sync Status</label>
                                <div class="d-flex align-items-center">
                                    {% if transaction.sync_status.value == 'synced' %}
                                    <div class="bg-dark-gray rounded p-2 me-3">
                                        <i class="bi bi-cloud-check text-success"></i>
                                    </div>
                                    <div>
                                        <div class="text-success">Synced</div>
                                        <small class="text-gray">Cloud sync complete</small>
                                    </div>
                                    {% elif transaction.sync_status.value == 'pending' %}
                                    <div class="bg-dark-gray rounded p-2 me-3">
                                        <i class="bi bi-cloud-arrow-up text-warning"></i>
                                    </div>
                                    <div>
                                        <div class="text-warning">Pending</div>
                                        <small class="text-gray">Waiting for sync</small>
                                    </div>
                                    {% else %}
                                    <div class="bg-dark-gray rounded p-2 me-3">
                                        <i class="bi bi-device-hdd text-gray"></i>
                                    </div>
                                    <div>
                                        <div class="text-light">Local Only</div>
                                        <small class="text-gray">Not synced to cloud</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline -->
                    <div class="mt-4 pt-4 border-top border-secondary">
                        <h6 class="mb-3 text-gray"><i class="bi bi-clock-history me-2"></i>Transaction Timeline</h6>
                        <div class="d-flex align-items-center text-gray">
                            <div class="me-4">
                                <i class="bi bi-calendar-plus"></i>
                                <small class="ms-1">Created: {{ transaction.created_at.strftime('%b %d, %Y %I:%M %p') }}</small>
                            </div>
                            {% if transaction.updated_at != transaction.created_at %}
                            <div>
                                <i class="bi bi-pencil-square"></i>
                                <small class="ms-1">Updated: {{ transaction.updated_at.strftime('%b %d, %Y %I:%M %p') }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Delete Action -->
                    <div class="mt-4 pt-4 border-top border-secondary">
                        <h6 class="text-danger mb-3"><i class="bi bi-exclamation-triangle me-2"></i>Danger Zone</h6>
                        <p class="text-gray small mb-3">Deleting this transaction will permanently remove it and adjust the account balance.</p>
                        <form method="POST" action="{{ url_for('transactions.delete', transaction_id=transaction.id) }}"
                              onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="bi bi-trash me-1"></i> Delete Transaction
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <!-- Account Impact -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Account Impact</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-gray">Previous Balance</span>
                            <span class="text-light">
                                {{ transaction.account.currency }} {{ "%.2f"|format(transaction.account.current_balance - transaction.amount if transaction.type.value == 'income' else transaction.account.current_balance + transaction.amount) }}
                            </span>
                        </div>
                        <div class="progress mb-2" style="height: 4px;">
                            <div class="progress-bar bg-gray" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="{{ 'text-success' if transaction.type.value == 'income' else 'text-danger' }}">
                                {{ '+' if transaction.type.value == 'income' else '-' }}{{ transaction.account.currency }} {{ "%.2f"|format(transaction.amount) }}
                            </span>
                            <i class="bi bi-arrow-right text-gray"></i>
                        </div>
                        <div class="progress mb-2" style="height: 4px;">
                            <div class="progress-bar {{ 'bg-success' if transaction.type.value == 'income' else 'bg-danger' }}" 
                                 style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-gray">New Balance</span>
                            <span class="text-light fw-bold">
                                {{ transaction.account.currency }} {{ "%.2f"|format(transaction.account.current_balance) }}
                            </span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-accent" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('transactions.create') }}?account_id={{ transaction.account_id }}" 
                           class="btn btn-outline-accent text-start">
                            <i class="bi bi-plus-circle me-2"></i> Add to Same Account
                        </a>
                        <a href="{{ url_for('accounts.view', account_id=transaction.account_id) }}" 
                           class="btn btn-outline-accent text-start">
                            <i class="bi bi-wallet2 me-2"></i> View Account
                        </a>
                        {% if transaction.category %}
                        <a href="{{ url_for('transactions.index') }}?category_id={{ transaction.category_id }}" 
                           class="btn btn-outline-accent text-start">
                            <i class="bi bi-folder me-2"></i> View Similar Transactions
                        </a>
                        {% endif %}
                        <a href="{{ url_for('transactions.index') }}?account_id={{ transaction.account_id }}" 
                           class="btn btn-outline-accent text-start">
                            <i class="bi bi-list-ul me-2"></i> Account Transactions
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Share/Export -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-share me-2"></i>Share & Export</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-accent text-start" onclick="copyTransactionDetails()">
                            <i class="bi bi-clipboard me-2"></i> Copy Details
                        </button>
                        <a href="mailto:?subject=Transaction%20Details&body={{ transaction.description or 'Transaction' }}%3A%20{{ '$%.2f'|format(transaction.amount) }}%20on%20{{ transaction.date.strftime('%B %d, %Y') }}" 
                           class="btn btn-outline-accent text-start">
                            <i class="bi bi-envelope me-2"></i> Email Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function copyTransactionDetails() {
        const details = `Transaction: ${document.querySelector('.h2').textContent.trim()}
Date: {{ transaction.date.strftime('%B %d, %Y') }}
Description: {{ transaction.description or 'No description' }}
Account: {{ transaction.account.name }}
Category: {{ transaction.category.name if transaction.category else 'Uncategorized' }}
Type: {{ transaction.type.value|title }}
Amount: {{ '$%.2f'|format(transaction.amount) }} {{ transaction.account.currency }}`;
        
        navigator.clipboard.writeText(details)
            .then(() => {
                alert('Transaction details copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy details');
            });
    }
</script>
{% endblock %}