{% extends "accounts/layout.html" %}

{% block title %}Transactions - The Brilliant Emporium{% endblock %}

{% block main %}
<div class="container py-4">
    <!-- Page Header with Animation -->
    <div class="d-flex justify-content-between align-items-center mb-4 fade-in-up">
        <div>
            <h1 class="h2 fw-bold mb-0"><i class="bi bi-arrow-left-right text-accent me-2"></i>Transactions</h1>
            <p class="text-gray mb-0">Track all your income and expenses</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('transactions.export_csv') }}{% if request.args %}?{{ request.query_string.decode() }}{% endif %}" 
               class="btn btn-outline-accent hover-lift">
                <i class="bi bi-download me-1"></i> Export CSV
            </a>
            <a href="{{ url_for('transactions.create') }}" class="btn btn-accent hover-lift pulse-on-hover">
                <i class="bi bi-plus-circle me-1"></i> New Transaction
            </a>
        </div>
    </div>
    
    <!-- Filter Card with Slide Animation -->
    <div class="card filter-card mb-4 slide-in-right">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-funnel me-2"></i> Filter Transactions</h6>
            <button class="btn btn-sm btn-outline-accent" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        <div class="collapse show" id="filterCollapse">
            <div class="card-body">
                <form method="GET" action="{{ url_for('transactions.index') }}" class="row g-3" id="filterForm">
                    <div class="col-md-3">
                        <label class="form-label">Date From</label>
                        <input type="date" class="form-control" name="date_from" 
                               value="{{ request.args.get('date_from', '') }}" 
                               max="{{ date.today().strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date To</label>
                        <input type="date" class="form-control" name="date_to" 
                               value="{{ request.args.get('date_to', '') }}"
                               max="{{ date.today().strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Account</label>
                        <select class="form-select" name="account_id">
                            <option value="">All Accounts</option>
                            {% for acc in accounts %}
                            <option value="{{ acc.id }}" {% if request.args.get('account_id')|string == acc.id|string %}selected{% endif %}>
                                {{ acc.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category_id">
                            <option value="">All Categories</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if request.args.get('category_id')|string == cat.id|string %}selected{% endif %}>
                                {{ cat.icon }} {{ cat.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Type</label>
                        <select class="form-select" name="type">
                            <option value="">All Types</option>
                            <option value="income" {% if request.args.get('type') == 'income' %}selected{% endif %}>Income</option>
                            <option value="expense" {% if request.args.get('type') == 'expense' %}selected{% endif %}>Expense</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" name="search" 
                                   placeholder="Search description or amount..." 
                                   value="{{ request.args.get('search', '') }}">
                        </div>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <div class="d-flex gap-2 w-100">
                            <button type="submit" class="btn btn-accent flex-grow-1 hover-lift">
                                <i class="bi bi-search me-1"></i> Apply Filters
                            </button>
                            {% if request.args %}
                            <button type="button" class="btn btn-outline-accent hover-lift" onclick="window.location.href='{{ url_for('transactions.index') }}'" title="Clear Filters">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Quick Stats with Counter Animation -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stat-card hover-lift slide-in-up" data-delay="0">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-dark-gray rounded-circle p-3 me-3 stat-icon">
                            <i class="bi bi-list-ul text-accent fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-gray small">Total Transactions</div>
                            <h3 class="mb-0 counter" data-target="{{ transactions.total if transactions else 0 }}">0</h3>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 3px;">
                        <div class="progress-bar bg-accent" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift slide-in-up" data-delay="100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-dark-gray rounded-circle p-3 me-3 stat-icon">
                            <i class="bi bi-arrow-down-left text-success fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-gray small">Total Income</div>
                            <h3 class="mb-0 text-success counter" data-target="{{ transactions.items|selectattr('type.value', 'equalto', 'income')|map(attribute='amount')|sum|float }}">
                                $0.00
                            </h3>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 3px;">
                        <div class="progress-bar bg-success" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift slide-in-up" data-delay="200">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-dark-gray rounded-circle p-3 me-3 stat-icon">
                            <i class="bi bi-arrow-up-right text-danger fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-gray small">Total Expenses</div>
                            <h3 class="mb-0 text-danger counter" data-target="{{ transactions.items|selectattr('type.value', 'equalto', 'expense')|map(attribute='amount')|sum|float }}">
                                $0.00
                            </h3>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 3px;">
                        <div class="progress-bar bg-danger" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift slide-in-up" data-delay="300">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-dark-gray rounded-circle p-3 me-3 stat-icon">
                            <i class="bi bi-graph-up text-accent fs-5"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-gray small">Net Total</div>
                            <h3 class="mb-0 counter {{ 'text-success' if (transactions.items|selectattr('type.value', 'equalto', 'income')|map(attribute='amount')|sum|float) - (transactions.items|selectattr('type.value', 'equalto', 'expense')|map(attribute='amount')|sum|float) >= 0 else 'text-danger' }}" 
                                data-target="{{ (transactions.items|selectattr('type.value', 'equalto', 'income')|map(attribute='amount')|sum|float) - (transactions.items|selectattr('type.value', 'equalto', 'expense')|map(attribute='amount')|sum|float) }}">
                                $0.00
                            </h3>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 3px;">
                        <div class="progress-bar {{ 'bg-success' if (transactions.items|selectattr('type.value', 'equalto', 'income')|map(attribute='amount')|sum|float) - (transactions.items|selectattr('type.value', 'equalto', 'expense')|map(attribute='amount')|sum|float) >= 0 else 'bg-danger' }}" 
                             style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transactions Table -->
    <div class="card fade-in">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Transactions</h5>
            <div class="d-flex align-items-center">
                <span class="text-gray me-3">{{ transactions.total }} transaction{{ 's' if transactions.total != 1 else '' }}</span>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-accent dropdown-toggle hover-lift" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-sort-down me-1"></i> Sort
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="?sort=date_desc">Date (Newest First)</a></li>
                        <li><a class="dropdown-item" href="?sort=date_asc">Date (Oldest First)</a></li>
                        <li><a class="dropdown-item" href="?sort=amount_desc">Amount (High to Low)</a></li>
                        <li><a class="dropdown-item" href="?sort=amount_asc">Amount (Low to High)</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if transactions.items %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Account</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions.items %}
                        <tr class="transaction-row {{ 'transaction-income' if transaction.type.value == 'income' else 'transaction-expense' }} animate-in" 
                            data-animation-delay="{{ loop.index * 50 }}"
                            onclick="window.location='{{ url_for('transactions.view', transaction_id=transaction.id) }}'">
                            <td onclick="event.stopPropagation();">
                                <div class="form-check">
                                    <input class="form-check-input transaction-checkbox" type="checkbox" 
                                           value="{{ transaction.id }}" data-transaction-id="{{ transaction.id }}">
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <strong>{{ transaction.date.strftime('%b %d') }}</strong>
                                    <small class="text-gray">{{ transaction.date.strftime('%Y') }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        {% if transaction.category and transaction.category.icon %}
                                        <span class="fs-4 transaction-icon">{{ transaction.category.icon }}</span>
                                        {% else %}
                                        <i class="bi bi-cash text-gray fs-4"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>{{ transaction.description or 'No description' }}</strong>
                                        {% if transaction.description and transaction.description|length > 50 %}
                                        <div class="text-gray small">{{ transaction.description[:50] }}...</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if transaction.category %}
                                <span class="category-badge badge rounded-pill" 
                                      style="background-color: {{ transaction.category.color }}20; color: {{ transaction.category.color }}; border: 1px solid {{ transaction.category.color }}40;">
                                    <i class="bi bi-tag-fill me-1"></i>{{ transaction.category.name }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary rounded-pill">Uncategorized</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-wallet2 text-gray me-2"></i>
                                    <span>{{ transaction.account.name if transaction.account else 'Unknown' }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge {{ 'bg-success' if transaction.type.value == 'income' else 'bg-danger' }} rounded-pill px-3 py-1">
                                    <i class="bi {{ 'bi-arrow-down-left' if transaction.type.value == 'income' else 'bi-arrow-up-right' }} me-1"></i>
                                    {{ transaction.type.value|title }}
                                </span>
                            </td>
                            <td>
                                <div class="{{ 'amount-income' if transaction.type.value == 'income' else 'amount-expense' }}">
                                    <strong class="fs-5">{{ '$%.2f'|format(transaction.amount) }}</strong>
                                    <div class="text-gray small">{{ transaction.account.currency if transaction.account else 'USD' }}</div>
                                </div>
                            </td>
                            <td onclick="event.stopPropagation();">
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('transactions.view', transaction_id=transaction.id) }}" 
                                       class="btn btn-outline-accent hover-lift" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('transactions.edit', transaction_id=transaction.id) }}" 
                                       class="btn btn-outline-accent hover-lift" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger hover-lift" 
                                            onclick="deleteTransaction('{{ transaction.id }}', event)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Bulk Actions -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top border-secondary" 
                 id="bulkActions" style="display: none;">
                <div>
                    <span id="selectedCount" class="text-light">0 transactions selected</span>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-danger hover-lift" onclick="deleteSelectedTransactions()">
                        <i class="bi bi-trash me-1"></i> Delete Selected
                    </button>
                </div>
            </div>
            
            <!-- Pagination -->
            {% if transactions.pages > 1 %}
            <div class="card-footer">
                <nav aria-label="Transaction pagination">
                    <ul class="pagination justify-content-center mb-0">
                        {% if transactions.has_prev %}
                        <li class="page-item">
                            <a class="page-link hover-lift" href="{{ url_for('transactions.index', page=transactions.prev_num, **request.args) }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in transactions.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
                            {% if page_num %}
                                <li class="page-item {% if page_num == transactions.page %}active{% endif %}">
                                    <a class="page-link hover-lift" href="{{ url_for('transactions.index', page=page_num, **request.args) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if transactions.has_next %}
                        <li class="page-item">
                            <a class="page-link hover-lift" href="{{ url_for('transactions.index', page=transactions.next_num, **request.args) }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-5 fade-in">
                <div class="mb-4">
                    <i class="bi bi-arrow-left-right text-gray fs-1 mb-3" style="font-size: 4rem!important;"></i>
                </div>
                <h5 class="text-light">No Transactions Found</h5>
                <p class="text-gray mb-4">
                    {% if request.args %}
                    Try changing your filter criteria
                    {% else %}
                    Start by adding your first transaction
                    {% endif %}
                </p>
                <div class="d-flex justify-content-center gap-2">
                    {% if request.args %}
                    <a href="{{ url_for('transactions.index') }}" class="btn btn-outline-accent hover-lift">
                        <i class="bi bi-x me-1"></i> Clear Filters
                    </a>
                    {% endif %}
                    <a href="{{ url_for('transactions.create') }}" class="btn btn-accent hover-lift pulse-on-hover">
                        <i class="bi bi-plus-circle me-1"></i> Add Transaction
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Loading Spinner Template -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark-gray border-secondary">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-accent mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-light">Processing...</h5>
            </div>
        </div>
    </div>
</div>

<style>
    /* Enhanced Animations */
    .fade-in-up {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.6s ease forwards;
    }
    
    .slide-in-right {
        opacity: 0;
        transform: translateX(-20px);
        animation: slideInRight 0.5s ease forwards 0.2s;
    }
    
    .slide-in-up {
        opacity: 0;
        transform: translateY(20px);
        animation: slideInUp 0.5s ease forwards;
    }
    
    .fade-in {
        opacity: 0;
        animation: fadeIn 0.8s ease forwards 0.3s;
    }
    
    .animate-in {
        opacity: 0;
        transform: translateX(-10px);
        animation: slideInLeft 0.5s ease forwards;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* Hover Effects */
    .hover-lift {
        transition: all 0.2s ease;
    }
    
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
    }
    
    .pulse-on-hover:hover {
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Enhanced Cards */
    .stat-card {
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }
    
    .stat-card:hover {
        border-color: var(--accent);
        transform: translateY(-5px);
    }
    
    .stat-icon {
        transition: all 0.3s ease;
    }
    
    .stat-card:hover .stat-icon {
        background-color: var(--accent) !important;
    }
    
    .stat-card:hover .stat-icon i {
        color: var(--black) !important;
    }
    
    /* Transaction Rows */
    .transaction-row {
        transition: all 0.2s ease;
        cursor: pointer;
        border-left: 3px solid transparent;
    }
    
    .transaction-income {
        border-left-color: var(--success);
    }
    
    .transaction-expense {
        border-left-color: var(--error);
    }
    
    .transaction-row:hover {
        background-color: rgba(255, 255, 255, 0.05) !important;
        transform: translateX(5px);
    }
    
    .transaction-icon {
        transition: all 0.3s ease;
    }
    
    .transaction-row:hover .transaction-icon {
        transform: scale(1.2);
    }
    
    /* Filter Card */
    .filter-card .card-header {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .filter-card .card-header:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Counter Animation */
    .counter {
        font-variant-numeric: tabular-nums;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
        }
        
        .stat-card .fs-5 {
            font-size: 1rem !important;
        }
    }
</style>

<script>
    // Bulk selection functionality
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        
        // Animate elements with delay
        const slideElements = document.querySelectorAll('.slide-in-up');
        slideElements.forEach((el, index) => {
            const delay = parseInt(el.getAttribute('data-delay')) || 0;
            setTimeout(() => {
                el.style.animationDelay = `${delay}ms`;
                el.classList.add('slide-in-up');
            }, 100);
        });
        
        // Animate table rows
        const tableRows = document.querySelectorAll('.animate-in');
        tableRows.forEach((row, index) => {
            const delay = parseInt(row.getAttribute('data-animation-delay')) || 0;
            setTimeout(() => {
                row.style.animationDelay = `${delay}ms`;
                row.classList.add('animate-in');
            }, 300);
        });
        
        // Animate counters
        animateCounters();
        
        function updateBulkActions() {
            const selected = Array.from(transactionCheckboxes).filter(cb => cb.checked);
            selectedCount.textContent = `${selected.length} transaction${selected.length !== 1 ? 's' : ''} selected`;
            bulkActions.style.display = selected.length > 0 ? 'flex' : 'none';
            
            // Add animation to bulk actions
            if (selected.length > 0 && bulkActions.style.opacity !== '1') {
                bulkActions.style.opacity = '0';
                bulkActions.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    bulkActions.style.transition = 'all 0.3s ease';
                    bulkActions.style.opacity = '1';
                    bulkActions.style.transform = 'translateY(0)';
                }, 10);
            }
        }
        
        selectAllCheckbox.addEventListener('change', function() {
            transactionCheckboxes.forEach(cb => {
                cb.checked = this.checked;
                // Add animation to checkbox
                if (this.checked) {
                    cb.parentElement.classList.add('animate__animated', 'animate__pulse');
                    setTimeout(() => {
                        cb.parentElement.classList.remove('animate__animated', 'animate__pulse');
                    }, 300);
                }
            });
            updateBulkActions();
        });
        
        transactionCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                // Add animation on check
                if (this.checked) {
                    this.parentElement.classList.add('animate__animated', 'animate__pulse');
                    setTimeout(() => {
                        this.parentElement.classList.remove('animate__animated', 'animate__pulse');
                    }, 300);
                }
                updateBulkActions();
            });
        });
        
        // Initialize bulk actions
        updateBulkActions();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+A to select all
            if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                selectAllCheckbox.checked = !selectAllCheckbox.checked;
                selectAllCheckbox.dispatchEvent(new Event('change'));
            }
            
            // Escape to deselect all
            if (e.key === 'Escape') {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.dispatchEvent(new Event('change'));
            }
        });
    });
    
    // Helper to retrieve CSRF token (safe: prefer global helper when available)
    function getCsrfToken() {
        if (typeof window.getCsrfToken === 'function' && window.getCsrfToken !== getCsrfToken) {
            try {
                return window.getCsrfToken();
            } catch (e) {
                // Fall back to local methods
            }
        }

        // Local fallbacks
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta && meta.content) return meta.content;
        const match = document.cookie.match(/(^|;)\s*csrf_token=([^;]+)/);
        if (match) return decodeURIComponent(match[2]);
        const el = document.querySelector('input[name="csrf_token"]');
        if (el) return el.value;
        return '';
    }
    
    // Animate counters
    function animateCounters() {
        const counters = document.querySelectorAll('.counter');
        counters.forEach(counter => {
            const target = counter.getAttribute('data-target');
            if (!target) return;
            
            const isCurrency = counter.textContent.includes('$');
            const start = 0;
            const duration = 1500;
            const increment = target / (duration / 16);
            let current = start;
            
            const updateCounter = () => {
                current += increment;
                if (current >= target) {
                    counter.textContent = isCurrency ? '$' + parseFloat(target).toFixed(2) : Math.round(target);
                } else {
                    counter.textContent = isCurrency ? '$' + current.toFixed(2) : Math.round(current);
                    requestAnimationFrame(updateCounter);
                }
            };
            
            requestAnimationFrame(updateCounter);
        });
    }
    
    function deleteTransaction(transactionId, event) {
        event.stopPropagation();
        
        if (confirm('Are you sure you want to delete this transaction?')) {
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            fetch(`/transactions/${transactionId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                if (data.success) {
                    // Animate removal
                    const row = event.target.closest('.transaction-row');
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-100px)';
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                } else {
                    alert('Error deleting transaction: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                loadingModal.hide();
                console.error('Error:', error);
                alert('Error deleting transaction');
            });
        }
    }

    function deleteSelectedTransactions() {
        const selected = Array.from(document.querySelectorAll('.transaction-checkbox:checked'))
                            .map(cb => cb.value);

        if (selected.length === 0) return;

        if (confirm(`Are you sure you want to delete ${selected.length} transaction${selected.length !== 1 ? 's' : ''}?`)) {
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            fetch('{{ url_for("transactions.bulk_delete") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ transaction_ids: selected })
            })
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                if (data.success) {
                    // Animate removal of selected rows
                    document.querySelectorAll('.transaction-checkbox:checked').forEach(cb => {
                        const row = cb.closest('.transaction-row');
                        row.style.transition = 'all 0.3s ease';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(-100px)';
                    });
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    alert('Error deleting transactions: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                loadingModal.hide();
                console.error('Error:', error);
                alert('Error deleting transactions');
            });
        }
    }
    
    // Form submission with animation
    document.getElementById('filterForm')?.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spin me-1"></i> Applying...';
        submitBtn.disabled = true;
        
        // Add spinning animation to icon
        const icon = submitBtn.querySelector('.spin');
        icon.style.animation = 'spin 1s linear infinite';
        
        // Show loading state
        const tableBody = document.querySelector('tbody');
        if (tableBody) {
            tableBody.style.opacity = '0.5';
            tableBody.style.transition = 'opacity 0.3s ease';
        }
    });
    
    // Add spinning animation style
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}