{% extends "accounts/layout.html" %}

{% block title %}Edit Transfer - The Brilliant Emporium{% endblock %}

{% block extras %}
<style>
    .form-card {
        opacity: 0;
        transform: translateY(30px);
        animation: slideInUp 0.6s ease forwards;
        animation-delay: 0.2s;
    }
    
    .info-card {
        opacity: 0;
        transform: translateY(30px);
        animation: slideInUp 0.6s ease forwards;
        animation-delay: 0.4s;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .form-step {
        opacity: 0;
        transform: translateX(-20px);
        animation: slideInLeft 0.5s ease forwards;
    }
    
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .transfer-details {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(255, 255, 255, 0.05));
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid rgba(13, 110, 253, 0.2);
    }
    
    .transfer-timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .transfer-timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--info), transparent);
    }
    
    .timeline-step {
        position: relative;
        margin-bottom: 25px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 3px solid var(--info);
    }
    
    .timeline-step::before {
        content: '';
        position: absolute;
        left: -30px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--info);
        border: 3px solid var(--dark-gray);
    }
    
    .timeline-step.completed::before {
        background: var(--success);
    }
    
    .input-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-gray);
        transition: all 0.3s ease;
        z-index: 1;
    }
    
    .form-control:focus + .input-icon {
        color: var(--accent);
        transform: translateY(-50%) scale(1.1);
    }
    
    .tip-item {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.03);
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .tip-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-left-color: var(--accent);
        transform: translateX(5px);
    }
    
    .tip-item i {
        color: var(--accent);
        transition: all 0.3s ease;
    }
    
    .tip-item:hover i {
        transform: rotate(10deg) scale(1.1);
    }
    
    .hover-lift {
        transition: all 0.3s ease;
    }
    
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
    }
    
    .fade-in {
        opacity: 0;
        animation: fadeIn 0.8s ease forwards;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .account-display {
        padding: 15px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 15px;
    }
    
    .account-display.from {
        border-left: 4px solid var(--danger);
    }
    
    .account-display.to {
        border-left: 4px solid var(--success);
    }
</style>
{% endblock %}

{% block main %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="mb-4 fade-in">
                <a href="{{ url_for('transfers.index') }}" class="btn btn-outline-accent btn-sm mb-3 hover-lift">
                    <i class="bi bi-arrow-left me-1"></i> Back to Transfers
                </a>
                <h1 class="h2 fw-bold">
                    <i class="bi bi-pencil-square text-accent me-2"></i>
                    Edit Transfer
                </h1>
                <p class="text-gray">Update transfer details (Note: Account changes will reverse and reapply the transfer)</p>
            </div>
            
            <!-- Transfer Timeline -->
            <div class="transfer-details fade-in">
                <h5 class="mb-4"><i class="bi bi-clock-history text-accent me-2"></i>Transfer Timeline</h5>
                <div class="transfer-timeline">
                    <div class="timeline-step">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Transfer Created</h6>
                                <small class="text-gray">{{ transfer.created_at.strftime('%b %d, %Y %I:%M %p') }}</small>
                            </div>
                            <span class="badge bg-info">Completed</span>
                        </div>
                    </div>
                    <div class="timeline-step">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-gray d-block mb-1">From Account</small>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-wallet2 text-danger me-2"></i>
                                    <strong>{{ transfer.from_account.name }}</strong>
                                </div>
                                <div class="text-light mt-1">${{ "%.2f"|format(transfer.amount) }} deducted</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-gray d-block mb-1">To Account</small>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-wallet2 text-success me-2"></i>
                                    <strong>{{ transfer.to_account.name }}</strong>
                                </div>
                                <div class="text-light mt-1">${{ "%.2f"|format(transfer.amount) }} added</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transfer Form -->
            <div class="card form-card">
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('transfers.edit', transfer_id=transfer.id) }}" id="transferForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Amount -->
                        <div class="mb-4 form-step" style="animation-delay: 0.1s">
                            <label class="form-label">Transfer Amount *</label>
                            <div class="position-relative">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark-gray border-secondary"><i class="bi bi-currency-dollar"></i></span>
                                    {{ form.amount(class="form-control ps-4", placeholder="0.00", step="0.01", min="0.01") }}
                                </div>
                                <div class="input-icon" style="left: 60px;">
                                    <i class="bi bi-cash-stack"></i>
                                </div>
                            </div>
                            {% if form.amount.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.amount.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Date -->
                        <div class="mb-4 form-step" style="animation-delay: 0.2s">
                            <label class="form-label">Transfer Date *</label>
                            <div class="position-relative">
                                {{ form.date(class="form-control ps-4", type="date") }}
                                <div class="input-icon">
                                    <i class="bi bi-calendar"></i>
                                </div>
                            </div>
                            {% if form.date.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Account Display (Read-only) -->
                        <div class="mb-4 form-step" style="animation-delay: 0.3s">
                            <label class="form-label">Accounts</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="account-display from">
                                        <small class="text-gray d-block mb-1">From Account</small>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-wallet2 text-danger me-2"></i>
                                                    <strong>{{ transfer.from_account.name }}</strong>
                                                </div>
                                                <div class="text-gray small mt-1">{{ transfer.from_account.type.value|replace('_', ' ')|title }}</div>
                                            </div>
                                            <div class="text-end">
                                                <div class="text-light">${{ "%.2f"|format(transfer.from_account.current_balance) }}</div>
                                                <div class="text-gray small">{{ transfer.from_account.currency }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="account-display to">
                                        <small class="text-gray d-block mb-1">To Account</small>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-wallet2 text-success me-2"></i>
                                                    <strong>{{ transfer.to_account.name }}</strong>
                                                </div>
                                                <div class="text-gray small mt-1">{{ transfer.to_account.type.value|replace('_', ' ')|title }}</div>
                                            </div>
                                            <div class="text-end">
                                                <div class="text-light">${{ "%.2f"|format(transfer.to_account.current_balance) }}</div>
                                                <div class="text-gray small">{{ transfer.to_account.currency }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-gray small mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                Changing accounts is not allowed. Create a new transfer to move money between different accounts.
                            </p>
                        </div>
                        
                        <!-- Description -->
                        <div class="mb-4 form-step" style="animation-delay: 0.4s">
                            <label class="form-label">Description (Optional)</label>
                            <div class="position-relative">
                                {{ form.description(class="form-control ps-4", placeholder="Add a note about this transfer...", rows="3") }}
                                <div class="input-icon">
                                    <i class="bi bi-chat-left-text"></i>
                                </div>
                            </div>
                            {% if form.description.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Balance Impact -->
                        <div class="mb-4 form-step" style="animation-delay: 0.5s">
                            <label class="form-label">Balance Impact</label>
                            <div class="card bg-dark-gray">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-gray d-block mb-2">From Account Impact</small>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Original Balance:</span>
                                                <span>${{ "%.2f"|format(transfer.from_account.current_balance + transfer.amount) }}</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <span>Transfer Amount:</span>
                                                <span class="text-danger">-${{ "%.2f"|format(transfer.amount) }}</span>
                                            </div>
                                            <hr class="my-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>New Balance:</strong>
                                                <strong>${{ "%.2f"|format(transfer.from_account.current_balance) }}</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-gray d-block mb-2">To Account Impact</small>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>Original Balance:</span>
                                                <span>${{ "%.2f"|format(transfer.to_account.current_balance - transfer.amount) }}</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <span>Transfer Amount:</span>
                                                <span class="text-success">+${{ "%.2f"|format(transfer.amount) }}</span>
                                            </div>
                                            <hr class="my-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>New Balance:</strong>
                                                <strong>${{ "%.2f"|format(transfer.to_account.current_balance) }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-5 form-step" style="animation-delay: 0.6s">
                            <div>
                                <a href="{{ url_for('transfers.index') }}" class="btn btn-outline-accent hover-lift me-2">Cancel</a>
                                <button type="button" class="btn btn-outline-danger hover-lift" onclick="confirmDelete()">
                                    <i class="bi bi-trash me-1"></i> Delete
                                </button>
                            </div>
                            <button type="submit" class="btn btn-accent hover-lift px-4" id="submitBtn">
                                <i class="bi bi-check-circle me-2"></i> Update Transfer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Edit Information -->
            <div class="card info-card mt-4">
                <div class="card-body">
                    <h6 class="mb-3"><i class="bi bi-lightbulb text-accent me-2"></i>Editing Transfer Notes</h6>
                    <div class="tip-item">
                        <i class="bi bi-calendar-check me-2"></i>
                        Changing the date only updates the transfer record, not the actual transaction timing
                    </div>
                    <div class="tip-item">
                        <i class="bi bi-cash-coin me-2"></i>
                        Amount changes will reverse the original transfer and create a new one with updated amounts
                    </div>
                    <div class="tip-item">
                        <i class="bi bi-shield-exclamation me-2"></i>
                        For significant changes, consider deleting and creating a new transfer for better audit trail
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark-gray border-secondary">
            <div class="modal-header border-0">
                <h5 class="modal-title text-light">Delete Transfer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                </div>
                <p class="text-light text-center">Are you sure you want to delete this transfer?</p>
                <p class="text-gray text-center small">
                    This will reverse the transfer and update account balances back to their original state.
                </p>
                <div class="text-center mt-3">
                    <div class="badge bg-danger mb-2">Warning: This action cannot be undone</div>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-accent hover-lift" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('transfers.delete', transfer_id=transfer.id) }}">
                    <button type="submit" class="btn btn-danger hover-lift">Delete Transfer</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const amountInput = document.getElementById('{{ form.amount.id }}');
        const dateInput = document.getElementById('{{ form.date.id }}');
        const submitBtn = document.getElementById('submitBtn');
        
        // Animate form steps
        const formSteps = document.querySelectorAll('.form-step');
        formSteps.forEach((step, index) => {
            setTimeout(() => {
                step.style.animation = `slideInLeft 0.5s ease forwards ${index * 0.1}s`;
            }, 100);
        });
        
        // Form validation
        function validateForm() {
            const amount = parseFloat(amountInput.value) || 0;
            let isValid = true;
            let errorMessage = '';
            
            // Check amount
            if (amount <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid amount';
            }
            
            submitBtn.disabled = !isValid;
            showErrorMessage(errorMessage);
            
            return isValid;
        }
        
        function showErrorMessage(message) {
            // Remove existing error
            const existingError = document.querySelector('.edit-error');
            if (existingError) existingError.remove();
            
            if (!message) return;
            
            // Create error element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-3 edit-error';
            errorDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill me-2"></i>${message}
                <button type="button" class="btn-close btn-close-white float-end" onclick="this.parentElement.remove()"></button>
            `;
            
            // Insert after form
            const form = document.querySelector('#transferForm');
            form.parentNode.insertBefore(errorDiv, form.nextSibling);
        }
        
        // Event listeners
        amountInput.addEventListener('input', validateForm);
        
        // Form submission animation
        const form = document.getElementById('transferForm');
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                return;
            }
            
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Updating...';
            submitBtn.disabled = true;
            
            // Animate form submission
            const formCard = document.querySelector('.form-card');
            formCard.style.transition = 'all 0.3s ease';
            formCard.style.opacity = '0.8';
        });
        
        // Initial validation
        validateForm();
    });
    
    function confirmDelete() {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
</script>
{% endblock %}